name: Pake Build and Release

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths:
      - 'applications/**'

permissions: {}

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false

      - name: Validate application JSON files
        run: |
          set -euo pipefail

          for file in applications/*.json; do
            echo "Validating $file..."
            jq -e '.token and .name and .url and .version' "$file" > /dev/null
          done

  build-and-release:
    needs: validate
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    if: |
      github.event.action != 'labeled' ||
      (github.event.action == 'labeled' && github.event.label.name == 'create-release')
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        name: Install pnpm
        with:
          version: 9

      - name: Cache Pake dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.pake
          key: ${{ runner.os }}-pake-${{ hashFiles('applications/*.json') }}
          restore-keys: |
            ${{ runner.os }}-pake-

      - name: Install Pake
        run: |
          pnpm install -g pake-cli
          rustup target add x86_64-apple-darwin

      - name: Get changed files
        id: changed-files
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          git fetch origin "$BASE_REF"
          files=$(git diff --name-only "origin/$BASE_REF" HEAD | grep '^applications/.*\.json$' || true)
          echo "Changed files:"
          echo "$files"
          
          # Handle multiline output
          {
            echo "files<<EOF"
            echo "$files"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Cache Build Artifacts
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: |
            *.dmg
          key: pake-artifacts-${{ hashFiles('applications/*.json') }}

      - name: Process Applications
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          set -euo pipefail

          if [ -z "$FILES" ]; then
            echo "No application JSON files changed."
            exit 0
          fi
          
          SHOULD_RELEASE=false
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'create-release') }}" == "true" ]]; then
            SHOULD_RELEASE=true
          fi
          
          echo "Release mode: $SHOULD_RELEASE"
          
          # Loop through each changed file
          while IFS= read -r file; do
            if [ -z "$file" ]; then continue; fi
            
            echo "Processing $file..."
            
            # Parse JSON content
            token=$(jq -r '.token' "$file")
            name=$(jq -r '.name' "$file")
            url=$(jq -r '.url' "$file")
            version=$(jq -r '.version' "$file")
            flags=$(jq -r '.flags // ""' "$file")
            
            echo "Building $name ($token) v$version from $url"
            if [ -n "$flags" ]; then
              echo "Using flags: $flags"
            fi
            
            dmg_file="${name}.dmg"
            
            if [ -f "$dmg_file" ]; then
              echo "Artifact $dmg_file found in cache. Skipping build."
            else
              # Build using pake
              # shellcheck disable=SC2086
              pake "$url" --name "$name" --multi-arch --app-version "$version" $flags
            fi
            
            # If release is requested
            if [ "$SHOULD_RELEASE" = true ]; then
              tag_name="${token}-${version}"
              release_title="${name} v${version}"
              
              if [ ! -f "$dmg_file" ]; then
                echo "Warning: $dmg_file not found, searching for any .dmg file..."
                dmg_file=$(find . -maxdepth 1 -name "*.dmg" | head -n 1)
              fi
              
              if [ -f "$dmg_file" ]; then
                echo "Found artifact: $dmg_file"
                
                # Create release and upload asset
                # We use '|| true' to prevent failure if release already exists, 
                # but ideally we should check or handle it. 
                # 'gh release create' will fail if tag exists.
                
                if gh release view "$tag_name" >/dev/null 2>&1; then
                  echo "Release $tag_name already exists. Uploading asset to existing release..."
                  gh release upload "$tag_name" "$dmg_file" --clobber
                else
                  echo "Creating new release $tag_name..."
                  gh release create "$tag_name" "$dmg_file" --title "$release_title" --generate-notes
                fi
              else
                echo "Error: Could not find built .dmg file for $name"
                exit 1
              fi
            fi
          done <<< "$FILES"
          
          # Merge PR if release was successful
          if [ "$SHOULD_RELEASE" = true ]; then
            echo "Merging Pull Request..."
            gh pr merge "${{ github.event.pull_request.number }}" --merge --delete-branch
          fi
